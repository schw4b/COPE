---
title: "COPE"
author: "Simon Schwab"
date: "21 Dec 2018"
output: html_notebook
---

## Libraries and loading data
```{r}
# install.packages("MASS")
# install.packages("ggplot2")
# install.packages("cowplot")
# install.packages("Hmisc")
# install.packages("car")
# install.packages("caret")
# install.packages("nlme")
# install.packages("nortest")

library(MASS)
library(ggplot2)
library(cowplot)
library(Hmisc)
library(car)
library(caret)
library(nlme)
library(biostatUZH)
library(knitr)
library(plyr)
library(nortest)
```

## Prepare data set
```{r}
# load
load("COPE_impM20.Rdata")

# 
t_24  = rep(FALSE, N*5)
t_24[481:600] = TRUE;
data.24 = subset(data.avg, subset = t_24)
data.24$group = revalue(data.24$ITT, c("ASSIP & ASSIP Drop out"="ASSIP", "CG & CG Drop out"="Controls"))

t_0  = rep(FALSE, N*5)
t_0[1:120] = TRUE;
data.0 = subset(data.avg, subset = t_0)
data.0$group = revalue(data.0$ITT, c("ASSIP & ASSIP Drop out"="ASSIP", "CG & CG Drop out"="Controls"))

# add F diagnoses for Table 1
# others is F5 F9
data.0$F1 = relevel(data$F1, ref="ja")
data.0$F3 = relevel(data$F3, ref="ja")
data.0$F4 = relevel(data$F4, ref="ja")
data.0$F5 = relevel(data$F5, ref="ja")
data.0$F6 = relevel(data$F6, ref="ja")
data.0$F9 = relevel(data$F9, ref="ja")
data.0$FOthers = rep("nein", N)
data.0$FOthers[data.0$F5 == "ja" | data.0$F9 == "ja"] = "ja"
data.0$FOthers = factor(data.0$FOthers, levels=c("ja", "nein"))

data.0$Married  = relevel(data$demot1_2_verheiratet, ref="ja")

data.0$Children = rep("nein", N)
data.0$Children[data$demot1_3_kinder > 0] = "ja"
data.0$Children = factor(data.0$Children, levels=c("ja", "nein"))

data.0$Employment = rep("nein", N)
data.0$Employment[data$Employment_dichotom == "Angestellt&angestell mit krankgeschrieben"] = "ja"
data.0$Employment = factor(data.0$Employment, levels=c("ja", "nein"))
```

## Helper functions
```{r}
mean.sd <- function(x) sprintf("%.1f (%.1f)", mean(x), sd(x))
mean.sd.2 <- function(x) sprintf("%.2f (%.2f)", mean(x), sd(x))
fmt.2 <- function(x) sprintf("%.2f", x)
pct <- function(x,n) round(x/n*100)
```


## Table 1 Demographics
```{r warning=FALSE}
table = data.frame(n = c(summary(data.0$group), length(data.0$group), "", ""))
rownames(table) = c(levels(data.0$group), "Total", "Test statistic", "p-value")

tmp = tapply(data.0$sex, data.0$group, summary)
test = chisq.test(data.frame(ASSIP=tmp$ASSIP, CG=tmp$Controls), correct = F)
table$sex = c(sprintf('%d/%d', tmp$ASSIP[1], tmp$ASSIP[2]),
              sprintf('%d/%d', tmp$Controls[1], tmp$Controls[2]),
              sprintf('%d/%d', summary(data.0$sex)[1], summary(data.0$sex)[2]),
              paste0('X^2^=',fmt.2(test$statistic)), formatPval(test$p.value))
              
# lillie.test(data.0$age)
test = wilcox.test(data = data.0, age ~ group)
table$age = c(tapply(data.0$age, data.0$group, mean.sd), mean.sd(data.0$age),
              paste0("W=",round(test$statistic)), 
              formatPval(test$p.value))

# Diagnosen
# others is F5 F9
n = N/2

tmp = table(data.0$F1, data.0$group)
test = chisq.test(tmp, correct = F)
table$F1 = c(sprintf('%d (%d%%)', tmp[1,1], pct(tmp[1,1], n)),
             sprintf('%d (%d%%)', tmp[1,2], pct(tmp[1,2], n)),
             sprintf('%d (%d%%)', sum(tmp[1,]), pct(sum(tmp[1,]), N)),
             paste0('X^2^=',fmt.2(test$statistic)), formatPval(test$p.value)
             )

tmp = table(data.0$F3, data.0$group)
test = chisq.test(tmp, correct = F)
table$F3 = c(sprintf('%d (%d%%)', tmp[1,1], pct(tmp[1,1], n)),
             sprintf('%d (%d%%)', tmp[1,2], pct(tmp[1,2], n)),
             sprintf('%d (%d%%)', sum(tmp[1,]), pct(sum(tmp[1,]), N)),
             paste0('X^2^=',fmt.2(test$statistic)), formatPval(test$p.value)
             )

tmp = table(data.0$F4, data.0$group)
test = chisq.test(tmp, correct = F)
table$F4 = c(sprintf('%d (%d%%)', tmp[1,1], pct(tmp[1,1], n)),
             sprintf('%d (%d%%)', tmp[1,2], pct(tmp[1,2], n)),
             sprintf('%d (%d%%)', sum(tmp[1,]), pct(sum(tmp[1,]), N)),
             paste0('X^2^=',fmt.2(test$statistic)), formatPval(test$p.value)
             )

tmp = table(data.0$F6, data.0$group)
test = chisq.test(tmp, correct = F)
table$F6 = c(sprintf('%d (%d%%)', tmp[1,1], pct(tmp[1,1], n)),
             sprintf('%d (%d%%)', tmp[1,2], pct(tmp[1,2], n)),
             sprintf('%d (%d%%)', sum(tmp[1,]), pct(sum(tmp[1,]), N)),
             paste0('X^2^=',fmt.2(test$statistic)), formatPval(test$p.value)
             )

tmp = table(data.0$FOthers, data.0$group)
test = chisq.test(tmp, correct = F)
table$Other = c(sprintf('%d (%d%%)', tmp[1,1], pct(tmp[1,1], n)),
             sprintf('%d (%d%%)', tmp[1,2], pct(tmp[1,2], n)),
             sprintf('%d (%d%%)', sum(tmp[1,]), pct(sum(tmp[1,]), N)),
             paste0('X^2^=',fmt.2(test$statistic)), formatPval(test$p.value)
             )

tmp = table(data.0$Married, data.0$group)
test = chisq.test(tmp, correct = F)
table$Married = c(sprintf('%d (%d%%)', tmp[1,1], pct(tmp[1,1], n)),
             sprintf('%d (%d%%)', tmp[1,2], pct(tmp[1,2], n)),
             sprintf('%d (%d%%)', sum(tmp[1,]), pct(sum(tmp[1,]), N)),
             paste0('X^2^=',fmt.2(test$statistic)), formatPval(test$p.value)
             )

tmp = table(data.0$Children, data.0$group)
test = chisq.test(tmp, correct = F)
table$Children = c(sprintf('%d (%d%%)', tmp[1,1], pct(tmp[1,1], n)),
             sprintf('%d (%d%%)', tmp[1,2], pct(tmp[1,2], n)),
             sprintf('%d (%d%%)', sum(tmp[1,]), pct(sum(tmp[1,]), N)),
             paste0('X^2^=',fmt.2(test$statistic)), formatPval(test$p.value)
             )

tmp = table(data.0$Employment, data.0$group)
test = chisq.test(tmp, correct = F)
table$Employed = c(sprintf('%d (%d%%)', tmp[1,1], pct(tmp[1,1], n)),
             sprintf('%d (%d%%)', tmp[1,2], pct(tmp[1,2], n)),
             sprintf('%d (%d%%)', sum(tmp[1,]), pct(sum(tmp[1,]), N)),
             paste0('X^2^=',fmt.2(test$statistic)), formatPval(test$p.value)
             )

# lillie.test(data.0$bdisum)
test = wilcox.test(data.0$bdisum ~ data.0$group)
table$BDI = c(tapply(data.0$bdisum, data.0$group, mean.sd),
              mean.sd(data.0$bdisum),
              paste0("W=",round(test$statistic)), 
              formatPval(test$p.value)
              )

# lillie.test(data.0$BSSsum)
test = wilcox.test(data.0$BSSsum ~ data.0$group)
table$BSS = c(tapply(data.0$BSSsum, data.0$group, mean.sd),
              mean.sd(data.0$BSSsum),
              paste0("W=",round(test$statistic)), 
              formatPval(test$p.value)
              )

# lillie.test(data.0$COPE_mean)
test = wilcox.test(data.0$COPE_mean ~ data.0$group)
table$COPE = c(tapply(data.0$COPE_mean, data.0$group, mean.sd.2),
              mean.sd.2(data.0$COPE_mean),
              paste0("W=",round(test$statistic)), 
              formatPval(test$p.value)
              )

kable(t(table))
```

## Main analyses at 24-month
```{r}
i = data.avg$time == 24
d = subset(data.avg, i)

wilcox.test(dysfunc_cop ~ ITT, data=d)
t.test(dysfunc_cop ~ ITT, data=d)
1-median(d$dysfunc_cop[is.assip])/median(d$dysfunc_cop[is.cg])

wilcox.test(prob_foc_cop ~ ITT, data=d)
median(d$prob_foc_cop[is.assip])/median(d$prob_foc_cop[is.cg])

wilcox.test(emo_foc_cop ~ ITT, data=d)
```

## ANOVA
```{r}
data.avg$id_nr = as.factor(data.avg$id_nr)
data.avg$time = as.factor(data.avg$time)
d=data.avg

fit = aov(dysfunc_cop ~ (time*ITT)+Error(id_nr/time) + ITT , data=d)
summary(fit)

fit = aov(prob_foc_cop ~ (time*ITT)+Error(id_nr/time) + ITT , data=d)
summary(fit)


fit = aov(emo_foc_cop ~ (time*ITT)+Error(id_nr/time) + ITT , data=d)
summary(fit)
```

## MANOVA
###Dysfunctional coping
```{r}
fit=manova(cbind(behav_diseng,
                 denial,self_dis,
                 self_blame,
                 subst_use,
                 venting) ~ (time*ITT)+Error(id_nr/time) + ITT, data=d)
summary(fit)
```

### Problem-focused coping
```{r}
fit=manova(cbind(act_cop,
                 inst_supo,
                 planning) ~ (time*ITT)+Error(id_nr/time) + ITT, data=d)
summary(fit)
```


```{r}
# sig. group effects or group*time interactions
fit = aov(self_dis ~ (time*ITT)+Error(id_nr/time) + ITT , data=d)
summary(fit)

fit = aov(self_blame ~ (time*ITT)+Error(id_nr/time) + ITT , data=d)
summary(fit)
```

## Spearman Correlation
```{r}
i = data.avg$time ==24 & data.avg$ITT == 'CG & CG Drop out'
d = subset(data.avg, i)
d$SV_24Mo = data$wSV_24Mo_sum[data$ITT == 'CG & CG Drop out']

cor.test(d$self_blame, d$SV_24Mo, method="spearman")
```


## ASSIP Group
```{r}
i = data.avg$time ==24 & data.avg$ITT == 'ASSIP & ASSIP Drop out'
d = subset(data.avg, i)

fit1 = lm(BSSsum ~ self_dis + act_cop + denial + subst_use + emo_supo + inst_supo + behav_diseng + 
            venting + pos_refram + planning + humor + accept + relig  + self_blame + 
            bdisum + previoussuicide_live_all, data = d)
fit2 = lm(BSSsum ~ self_dis + act_cop + denial + subst_use + emo_supo + behav_diseng + 
           venting + pos_refram + planning + humor + accept + relig + 
           bdisum + previoussuicide_live_all, data = d)

```

### Multicollinearity
```{r}
x = cbind(d$self_dis, d$act_cop, d$denial, d$subst_use, d$emo_supo, d$inst_supo, d$behav_diseng,
          d$venting, d$pos_refram, d$planning, d$humor, d$accept, d$relig, d$self_blame,
          d$bdisum, d$previoussuicide_live_all)
#print(round(cor(x)*100), digits = 2)

vif(fit1) > 4
vif(fit2) > 4
```

### Stepwise regression of BSS
```{r}
step1 = stepAIC(fit1, direction="both", trace = F)
step1$anova

step2 = stepAIC(fit2, direction="both", trace = F)
step2$anova
```

### Final model
```{r}
fit = lm(BSSsum ~ act_cop + subst_use + bdisum + previoussuicide_live_all, data = d)
# summary(fit)
tableRegression(fit, xtable = FALSE, stats = c("estimate", "ci.95", "t.value", "p.value"))
```

Relative importance
```{r}
varImp(fit, scale = FALSE)
```



## Control Group
```{r}
i = data.avg$time ==24 & data.avg$ITT == 'CG & CG Drop out'
d = subset(data.avg, i)

fit1 = lm(BSSsum ~ self_dis + act_cop + denial + subst_use + emo_supo + inst_supo + behav_diseng + 
            venting + pos_refram + planning + humor + accept + relig  + self_blame + 
            bdisum + previoussuicide_live_all, data = d)
fit2 = lm(BSSsum ~ self_dis + act_cop + denial + subst_use + emo_supo + behav_diseng + 
           venting + pos_refram + planning + humor + accept + relig + 
           bdisum + previoussuicide_live_all, data = d)

```

### Multicollinearity
```{r}
x = cbind(d$self_dis, d$act_cop, d$denial, d$subst_use, d$emo_supo, d$inst_supo, d$behav_diseng,
          d$venting, d$pos_refram, d$planning, d$humor, d$accept, d$relig, d$self_blame,
          d$bdisum, d$previoussuicide_live_all)
#print(round(cor(x)*100), digits = 2)


vif(fit1) > 4
vif(fit2) > 4
```

### Stepwise regression of BSS
```{r}
step1 = stepAIC(fit1, direction="both", trace = F)
step1$anova

step2 = stepAIC(fit2, direction="both", trace = F)
step2$anova

```

### Final model
```{r}
fit = lm(BSSsum ~ self_dis + behav_diseng + venting + pos_refram + bdisum + 
    previoussuicide_live_all, data = d)
summary(fit)
```
Relative importance
```{r}
varImp(fit, scale = FALSE)
```

## Figure 1
```{r, fig.height=2, fig.width=6, message=FALSE, warning=FALSE}
d = subset(data.avg, t_24)

p1 = ggplot(d, aes(x=ITT, y=dysfunc_cop, color=ITT)) +   geom_boxplot(width=0.8) +
  geom_point(shape=1, color="gray70", size=1, position = position_jitter(width = 0.3, height = 0.02)) +
  theme(legend.position="none", axis.text.x=element_blank(), plot.title = element_text(size = 12, face = "plain")) + ylab("Score") +
  xlab("") + ggtitle("Dysfunctional") + ylim(c(1,4))
 
p2 = ggplot(d, aes(x=ITT, y=prob_foc_cop, color=ITT)) +  geom_boxplot(width=0.8) +
  geom_point(shape=1, color="gray70", size=1, position = position_jitter(width = 0.3, height = 0.02)) +
  theme(legend.position="none", axis.text.x=element_blank(), plot.title = element_text(size = 12, face = "plain")) + ylab("") +
  xlab("") + ggtitle("Problem-focused") + ylim(c(1,4))

tmp=scale_colour_hue()

p3 = ggplot(d, aes(x=ITT, y=emo_foc_cop, color=ITT)) +  geom_boxplot(width=0.8) +
  geom_point(shape=1, color="gray70", size=1, position = position_jitter(width = 0.3, height = 0.02)) +
  ylab("") + xlab("") + theme(axis.text.x=element_blank(), plot.title = element_text(size = 12, face = "plain")) +
  ggtitle("Emotion-focused") + scale_color_manual(labels = c("ASSIP", "control\ngroup"), values = tmp$palette(2)) + ylim(c(1,4))

plot_grid(p1, p2, p3, ncol=3, nrow=1, labels=c("A", "B", "C"), rel_widths = c(0.62, 0.62, 1))
ggsave(path = "figures", "Fig1.png")
```

## Figure 2
```{r, fig.height=2, fig.width=6}

tmp=scale_colour_hue()
mylim=c(2,3.5)

p1 = ggplot(data.avg, aes(x=as.factor(time), y=self_dis, group=ITT, color=ITT)) +
  stat_summary(geom = "line", fun.y=mean) +
  stat_summary(geom = "point", fun.y=mean, size=3) +
  stat_summary(geom="errorbar", fun.data=mean_cl_boot, width = 0.3,
               fun.args=list(conf.int=0.95)) +
  theme(legend.position="none") + ggtitle("Self-distraction") + xlab("follow-up") + 
  ylab("Score") + theme(plot.title = element_text(size = 12, face = "plain")) +
  coord_cartesian(ylim=mylim)

p2 = ggplot(data.avg, aes(x=as.factor(time), y=self_blame, group=ITT, color=ITT)) +
  stat_summary(geom = "line", fun.y=mean) +
  stat_summary(geom = "point", fun.y=mean, size=3) +
  stat_summary(geom = "errorbar", fun.data=mean_cl_boot, width = 0.3,
               fun.args=list(conf.int=0.95)) +
  scale_color_manual(labels = c("ASSIP", "control\ngroup"), values = tmp$palette(2)) +
  ggtitle("Self-blame") + xlab("follow-up") + ylab("") +
  theme(plot.title = element_text(size = 12, face = "plain")) +
  coord_cartesian(ylim=mylim)
  
plot_grid(p1, p2, ncol=2, nrow=1, labels=c("A", "B"), rel_widths = c(0.7, 1))
ggsave(path = "figures", "Fig2.png")
```


## Cross table for self blame
### Prepare data for cross table
```{r}
t1=121:240
t2=241:360
t3=361:480
t4=481:600

t=0.69
rep = (data.avg$repeater[t1] > t) | (data.avg$repeater[t2] > t) |
      (data.avg$repeater[t3] > t) | (data.avg$repeater[t4] > t)

my.d24 = subset(data.avg, data.avg$time==24)
my.d24$rep = rep
```

### Cross-check with Plos Med paper Table 2 and comparision to imputed data
```{r}
x=array(c(sum(data.avg$repeater[t1][is.assip]==1), sum(data.avg$repeater[t2][is.assip]==1),
          sum(data.avg$repeater[t3][is.assip]==1), sum(data.avg$repeater[t4][is.assip]==1),
          sum(data.avg$repeater[t1][is.cg]==1), sum(data.avg$repeater[t2][is.cg]==1),
          sum(data.avg$repeater[t3][is.cg]==1), sum(data.avg$repeater[t4][is.cg]==1),
          sum(data.avg$repeater[t1][is.assip]>t), sum(data.avg$repeater[t2][is.assip]>t),
          sum(data.avg$repeater[t3][is.assip]>t), sum(data.avg$repeater[t4][is.assip]>t),
          sum(data.avg$repeater[t1][is.cg]>t), sum(data.avg$repeater[t2][is.cg]>t),
          sum(data.avg$repeater[t3][is.cg]>t), sum(data.avg$repeater[t4][is.cg]>t)),
          dim=c(4,4))
colnames(x)=c("ASSIP", "CG", "ASSIP (imp)", "CG (imp)")
rownames(x)=c("6m", "12m", "18m", "24m")
print(x)
```
Imputationd created additonal repeater in the control group, this group had 22% missing data.

### Repeater 1-24m
```{r}
c(sum(my.d24$rep[is.assip]), sum(my.d24$rep[is.cg]))
```

### Control Group
```{r}
sb=round(my.d24$self_blame)
x=array(c(sum(is.cg & my.d24$rep & (sb >= 1 & sb <= 2) ), sum(is.cg & !my.d24$rep & (sb >= 1 & sb <= 2) ),
          sum(is.cg & my.d24$rep & sb > 2), sum(is.cg & !my.d24$rep & sb > 2 )),
        dim=c(2,2))
colnames(x)=c("1-2", "2-4")
rownames(x)=c("repeater", "no repeater")
print(x)

# Percentage
print(x/rowSums(x))
```

### ASSIP
```{r}
x=array(c(sum(is.assip & my.d24$rep & (sb >= 1 & sb <= 2) ), sum(is.assip & !my.d24$rep & (sb >= 1 & sb <= 2) ),
          sum(is.assip & my.d24$rep & sb > 2), sum(is.assip & !my.d24$rep & sb > 2 )),
        dim=c(2,2))
colnames(x)=c("1-2", "2-4")
rownames(x)=c("repeater", "no repeater")
print(x)

# Percentage
print(x/rowSums(x))
```

